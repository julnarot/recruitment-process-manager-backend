trigger:
  branches:
    include:
      - main
  paths:
    include:
      - rpm-gateway/**

variables:
  dockerHubConnection: "dockerhub-rpm"
  dockerHubUser: "rjotac"
  imageName: "rpm-gateway"
  mavenOpts: "-Dmaven.test.skip=true"

stages:
  - stage: CI
    displayName: "Build & Push Auth Service"
    jobs:
      - job: BuildPush
        pool:
          vmImage: "ubuntu-latest"

        steps:
          - checkout: self
            clean: true

          - task: JavaToolInstaller@0
            inputs:
              versionSpec: "17"
              jdkArchitectureOption: "x64"
              jdkSourceOption: "PreInstalled"

          - task: Maven@3
            displayName: "Build rpm-gateway"
            inputs:
              mavenPomFile: "rpm-gateway/pom.xml"
              goals: "clean package"
              options: "$(mavenOpts)"
              publishJUnitResults: false

          - task: Docker@2
            displayName: "Build & Push rpm-gateway image"
            inputs:
              command: buildAndPush
              containerRegistry: "$(dockerHubConnection)"
              repository: "$(dockerHubUser)/$(imageName)"
              dockerfile: "rpm-gateway/Dockerfile"
              buildContext: "rpm-gateway"
              tags: |
                latest
                $(Build.BuildId)
